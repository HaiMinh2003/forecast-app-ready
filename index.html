<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>D·ª± b√°o Doanh thu S·∫£n ph·∫©m</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
</head>
<body class="p-4">
  <div class="container">
    <h2 class="mb-4">üîÆ D·ª± b√°o Doanh thu S·∫£n ph·∫©m theo Th√°ng</h2>

    <form id="forecastForm" enctype="multipart/form-data">
      <div class="mb-3">
        <label for="product" class="form-label">S·∫£n ph·∫©m</label>
        <select class="form-select" id="product" required>
          <option selected disabled>Ch·ªçn m√£ s·∫£n ph·∫©m...</option>
        </select>
      </div>

      <div class="mb-3">
        <label for="forecastMonths" class="form-label">S·ªë th√°ng c·∫ßn d·ª± b√°o</label>
        <input type="number" id="forecastMonths" class="form-control" value="1" min="1">
      </div>

      <div class="mb-3">
        <label for="country" class="form-label">Qu·ªëc gia</label>
        <select class="form-select" id="country">
          <option selected disabled>Ch·ªçn qu·ªëc gia...</option>
        </select>
      </div>

      <div class="mb-3">
        <label for="threshold" class="form-label">Ng∆∞·ª°ng c·∫£nh b√°o (%)</label>
        <input type="number" id="threshold" class="form-control" value="10">
      </div>

      <div class="mb-3">
        <label for="csvFile" class="form-label">Ch·ªçn file CSV d·ªØ li·ªáu</label>
        <input type="file" class="form-control" id="csvFile" accept=".csv">
      </div>

      <button type="submit" class="btn btn-primary">Ch·∫°y d·ª± b√°o</button>
    </form>

    <hr>
    <div id="results" class="mt-4">
      <h4>K·∫øt qu·∫£ D·ª± b√°o</h4>
      <div id="forecastTable"></div>
      <canvas id="forecastChart" height="150"></canvas>
    </div>

    <div id="suggestions" class="mt-4">
      <h4>üîç Ph√¢n t√≠ch & G·ª£i √Ω</h4>
      <div id="suggestionText" class="text-info"></div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script>
    document.getElementById('forecastForm').addEventListener('submit', async function(e) {
      e.preventDefault();

      const formData = new FormData();
      formData.append('file', document.getElementById('csvFile').files[0]);
      formData.append('stockCode', document.getElementById('product').value);
      formData.append('country', document.getElementById('country').value);
      formData.append('months', document.getElementById('forecastMonths').value);

      const threshold = parseFloat(document.getElementById('threshold').value);

      const res = await fetch('https://forecast-app-ready.onrender.com/forecast', {
        method: 'POST',
        body: formData
      });

      const data = await res.json();

      if (res.ok) {
        const labels = data.map(d => d.ds.split('T')[0]);
        const yhat = data.map(d => d.yhat.toFixed(2));
        const pct = data.map(d => d.pct_change.toFixed(1));

        const tableHTML = `
          <table class="table table-bordered mt-3">
            <thead><tr><th>Th√°ng</th><th>D·ª± b√°o</th><th>So v·ªõi TB 3T (%)</th></tr></thead>
            <tbody>${data.map(row => `
              <tr>
                <td>${row.ds.split('T')[0]}</td>
                <td>${row.yhat.toFixed(2)}</td>
                <td class="${Math.abs(row.pct_change) > threshold ? 'text-danger' : ''}">${row.pct_change.toFixed(1)}%</td>
              </tr>`).join('')}
            </tbody>
          </table>
        `;
        document.getElementById('forecastTable').innerHTML = tableHTML;

        const ctx = document.getElementById('forecastChart').getContext('2d');
        if (window.chartInstance) window.chartInstance.destroy();
        window.chartInstance = new Chart(ctx, {
          type: 'line',
          data: {
            labels,
            datasets: [{
              label: 'D·ª± b√°o Doanh thu',
              data: yhat,
              borderWidth: 2
            }]
          },
          options: {
            responsive: true
          }
        });

        // G·ª£i √Ω m·ªõi chu·∫©n h∆°n
        let suggestions = [];
        const product = document.getElementById('product').value;
        data.forEach((d, i) => {
          const date = new Date(d.ds);
          const monthLabel = `Th√°ng ${date.toLocaleDateString('vi-VN', { weekday: 'short', day: '2-digit' })}`;
          const pct = d.pct_change;
          const yhat = d.yhat;
          const tb3t = d.avg_yhat;

          // (1) ph√¢n t√≠ch ch√≠nh
          if (yhat > tb3t) {
            suggestions.push(`${monthLabel} c√≥ xu h∆∞·ªõng tƒÉng. Xem x√©t tƒÉng nh·∫≠p h√†ng v√† t·ªëi ∆∞u gi√° b√°n.`);
          } else {
            suggestions.push(`${monthLabel} c√≥ xu h∆∞·ªõng gi·∫£m. C·∫ßn xem x√©t khuy·∫øn m√£i ho·∫∑c gi·∫£m h√†ng t·ªìn.`);
          }

          // (2) c·∫£nh b√°o
          if (Math.abs(pct) > threshold) {
            suggestions.push(`‚ö†Ô∏è S·∫£n ph·∫©m ${product} c√≥ bi·∫øn ƒë·ªông doanh thu ${pct.toFixed(1)}%. R·ªßi ro t·ªìn kho.`);
          }
        });

        // (3) g·ª£i √Ω t·ªïng
        suggestions.push('üí° Duy tr√¨ theo d√µi ƒë·ªãnh k·ª≥. C·∫≠p nh·∫≠t m√¥ h√¨nh m·ªói th√°ng ƒë·ªÉ ph·∫£n √°nh bi·∫øn ƒë·ªông m·ªõi.');
        document.getElementById('suggestionText').innerHTML = suggestions.map(s => 'üìù ' + s).join('<br>');
      } else {
        alert("L·ªói: " + data.error);
      }
    });

    document.getElementById('csvFile').addEventListener('change', function () {
      const file = this.files[0];

      Papa.parse(file, {
        header: true,
        skipEmptyLines: true,
        complete: function(results) {
          const stockSet = new Set();
          const countrySet = new Set();

          results.data.slice(0, 300).forEach(row => {
            if (row['StockCode']) stockSet.add(row['StockCode'].trim());
            if (row['Country'] && isNaN(row['Country'].trim())) {
              countrySet.add(row['Country'].trim());
            }
          });

          const productDropdown = document.getElementById('product');
          const countryDropdown = document.getElementById('country');

          productDropdown.innerHTML = '<option selected disabled>Ch·ªçn m√£ s·∫£n ph·∫©m...</option>';
          countryDropdown.innerHTML = '<option selected disabled>Ch·ªçn qu·ªëc gia...</option>';

          [...stockSet].sort().forEach(code => {
            productDropdown.innerHTML += `<option value="${code}">${code}</option>`;
          });

          [...countrySet].sort().forEach(country => {
            countryDropdown.innerHTML += `<option value="${country}">${country}</option>`;
          });
        }
      });
    });
  </script>
</body>
</html>
